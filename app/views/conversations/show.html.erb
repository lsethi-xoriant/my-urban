<div class="chatboxhead">
  <div class="chatboxtitle">
    <i class="fa fa-comments"></i>
 
    <h1><%= @reciever.first_name %> </h1>
  </div>
  <div class="chatboxoptions">
    <%= link_to "<i class='fa  fa-minus'></i> ".html_safe, "#", class: "toggleChatBox", "data-cid" => @conversation.id %>
    &nbsp;&nbsp;
    <%= link_to "<i class='fa  fa-times'></i> ".html_safe, "#", class: "closeChat", "data-cid" => @conversation.id %>
  </div>
  <br clear="all"/>
</div>
<div class="chatboxcontent">
  <% if @messages.any? %>
      <%= render @messages %>
  <% end %>
</div>
<div class="chatboxinput">
  <%= form_for([@conversation, @message], :remote => true, :html => {id: "conversation_form_#{@conversation.id}"}) do |f| %>
      <%= f.text_area :body, class: "chatboxtextarea", "data-cid" => @conversation.id %>
  <% end %>
</div>
<script type="text/javascript">
  var conversation_id = <%=@conversation.id%>
  var source =  new EventSource('chat/sub/' + conversation_id);
  console.log(conversation_id);
  source.addEventListener('chat_event_'+ conversation_id, function(e) {
    console.log(e.data);
    var message =JSON.parse(e.data).message
    if (parseInt(message.user_id) !== parseInt($('meta[name=user-id]').attr("content"))){

      var id = message.conversation_id
      var chatbox = $("#chatbox_" + id + " .chatboxcontent");
      var sender_id = message.user_id
      var reciever_id = $('meta[name=user-id]').attr("content");
   
      chatbox.append('<li class="<%=  self_or_other_1(' + message.id+ ') %>"><div class="avatar"><img src="http://placehold.it/50x50" /></div><div class="chatboxmessagecontent"><p>'+message.body+'</p></div></li>');
      chatbox.scrollTop(chatbox[0].scrollHeight);
   
      if(sender_id != reciever_id){
        chatBox.chatWith(id);
          chatbox.children().last().removeClass("self").addClass("other");        
        chatbox.scrollTop(chatbox[0].scrollHeight);
          chatBox.notify();
      }
    }
  });
</script>
